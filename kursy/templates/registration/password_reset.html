{% extends 'base.html' %}
{% load static %}

{% block title %}Reset hasła - Platforma Kursowa{% endblock %}

{% block content %}
<article class="grid" style="max-width: 600px; margin: 0 auto;">
    <div>
        <hgroup>
            <h1>Reset hasła</h1>
            <p>Podaj adres e-mail, aby otrzymać instrukcję resetu hasła.</p>
        </hgroup>

        <form x-data="passwordResetForm()" @submit.prevent="submit">
            <!-- Success Message -->
            <template x-if="successMessage">
                <div style="padding: 1rem; margin-bottom: 1rem; border-radius: var(--pico-border-radius); border-left: 5px solid var(--pico-color-green-500); background-color: var(--pico-card-background-color);">
                    <strong x-text="successMessage"></strong>
                </div>
            </template>

            <!-- Error Alert -->
            <template x-if="errors.detail">
                <div style="padding: 1rem; margin-bottom: 1rem; border-radius: var(--pico-border-radius); border-left: 5px solid var(--pico-color-red-500); background-color: var(--pico-card-background-color);">
                    <strong x-text="errors.detail"></strong>
                </div>
            </template>

            <!-- Email Input -->
            <label for="email">
                Adres e-mail
                <input type="email" 
                       id="email" 
                       x-model="email" 
                       @input="errors.email = null; errors.detail = null"
                       placeholder="jan@kowalski.pl" 
                       required
                       :aria-invalid="errors.email ? 'true' : null">
                <template x-if="errors.email">
                    <small style="color: var(--pico-color-red-500);" x-text="errors.email[0]"></small>
                </template>
            </label>

            <!-- Submit Button -->
            <button type="submit" :aria-busy="isLoading" :disabled="isLoading">
                Zresetuj hasło
            </button>
            
            <p style="text-align: center; margin-top: 1rem;">
                <a href="{% url 'login' %}">Wróć do logowania</a>
            </p>
        </form>
    </div>
</article>
{% endblock %}

{% block extra_js %}
<script>
    function passwordResetForm() {
        return {
            email: '',
            isLoading: false,
            successMessage: null,
            errors: {},

            async submit() {
                this.isLoading = true;
                this.errors = {};
                this.successMessage = null;

                try {
                    const response = await window.apiClient('/api/auth/password-reset/', {
                        method: 'POST',
                        body: JSON.stringify({ email: this.email })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.successMessage = data.message || "Jeśli konto istnieje, wysłano link z instrukcją resetu hasła.";
                        this.email = ''; // Clear form
                    } else {
                        const data = await response.json();
                        if (response.status === 400 || response.status === 404) {
                             // Obsługa błędów walidacji lub logicznych
                             if (data.detail) {
                                 this.errors.detail = data.detail;
                             } else {
                                 this.errors = data;
                             }
                        } else {
                            this.errors.detail = "Wystąpił błąd serwera. Spróbuj ponownie później.";
                        }
                    }
                } catch (error) {
                    console.error(error);
                    this.errors.detail = "Wystąpił błąd połączenia.";
                } finally {
                    this.isLoading = false;
                }
            }
        };
    }
</script>
{% endblock %}

