name: Pull Request

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8
      - name: Lint with flake8
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  test:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run Tests
        run: |
          python manage.py test

  status-comment:
    needs: [lint, test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Post Status Comment
        uses: actions/github-script@v7
        with:
          script: |
            const lintStatus = '${{ needs.lint.result }}';
            const testStatus = '${{ needs.test.result }}';
            
            let message = '### Status PR ğŸš€\n\n';
            
            if (lintStatus === 'success' && testStatus === 'success') {
              message += 'âœ… **Sukces!** Wszystkie testy i lintowanie przeszÅ‚y pomyÅ›lnie.';
            } else {
              message += 'âŒ **Uwaga!** Wykryto problemy.\n\n';
              message += `* Lint: ${lintStatus === 'success' ? 'âœ…' : (lintStatus === 'skipped' ? 'âšª (PominiÄ™to)' : 'âŒ')}\n`;
              message += `* Testy: ${testStatus === 'success' ? 'âœ…' : (testStatus === 'skipped' ? 'âšª (PominiÄ™to)' : 'âŒ')}\n`;
            }
            
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            } else {
              console.log('Not a Pull Request, skipping comment posting.');
              console.log(message);
            }
